name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-typecheck:
    name: Lint and TypeCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: make install

      - name: Run linters
        run: make lint

      - name: Run TypeScript type checking
        run: make typecheck

  test-client:
    name: Client Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Install client dependencies
        run: cd stick-rumble-client && npm install

      - name: Run client tests
        run: make test-client

  test-server:
    name: Server Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install server dependencies
        run: cd stick-rumble-server && go mod download

      - name: Run server tests
        run: make test-server

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install events-schema dependencies
        run: cd events-schema && npm install

      - name: Validate JSON schemas
        run: make schema-validate

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: make install

      - name: Run integration tests
        run: make test-integration
