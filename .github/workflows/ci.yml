name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-typecheck:
    name: Lint and TypeCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: make install

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Run linters
        run: make lint

      - name: Run TypeScript type checking
        run: make typecheck

  test-client:
    name: Client Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Install client dependencies
        run: cd stick-rumble-client && npm install

      - name: Run client tests
        run: make test-client

  test-server:
    name: Server Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install server dependencies
        run: cd stick-rumble-server && go mod download

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Run server tests
        run: make test-server

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Validate JSON schemas
        run: make schema-validate

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: make install

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Build server binary
        run: cd stick-rumble-server && go build -o server-ci cmd/server/main.go

      - name: Verify server binary exists
        run: |
          if [ ! -f stick-rumble-server/server-ci ]; then
            echo "ERROR: Server binary not found after build"
            exit 1
          fi
          echo "Server binary built successfully"

      - name: Run integration tests
        run: make test-integration

      - name: Upload server logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-server-logs
          path: integration-server.log
          if-no-files-found: warn
          retention-days: 7

  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build events-schema
        run: cd events-schema && npm install && npm run build

      - name: Install client dependencies
        run: cd stick-rumble-client && npm install

      - name: Install Playwright browsers
        run: cd stick-rumble-client && npx playwright install --with-deps chromium

      - name: Run Playwright visual tests
        run: cd stick-rumble-client && npm run test:visual

      - name: Upload visual test report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: stick-rumble-client/playwright-report/
          if-no-files-found: warn
          retention-days: 7

      - name: Upload screenshot diffs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-diffs
          path: stick-rumble-client/test-results/
          if-no-files-found: warn
          retention-days: 7
